{% extends 'admin_panel/base.html' %}

{% block title %}Menu Management - Restaurant Admin Panel{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item active">Menu Management</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3">Menu Management</h1>
        <div>
            <a href="{% url 'admin_panel:category_add' %}" class="btn btn-primary me-2">
                <i class="fas fa-plus"></i> Add Category
            </a>
            <a href="{% url 'admin_panel:menu_item_add' %}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Add Menu Item
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Categories</h5>
                    <a href="{% url 'admin_panel:category_list' %}" class="btn btn-sm btn-outline-primary">View All</a>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for category in categories %}
                        <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas {{ category.icon_class }} me-2"></i>
                                <span>{{ category.name }}</span>
                                {% if not category.is_active %}
                                <span class="badge bg-secondary ms-2">Inactive</span>
                                {% endif %}
                            </div>
                            <div>
                                <a href="{% url 'admin_panel:menu_item_add' %}?category={{ category.id }}" class="btn btn-sm btn-outline-success me-1" title="Add item to this category">
                                    <i class="fas fa-plus"></i>
                                </a>
                                <a href="{% url 'admin_panel:category_edit' category.id %}" class="btn btn-sm btn-outline-primary me-1" title="Edit category">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <a href="{% url 'admin_panel:category_delete' category.id %}" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure you want to delete this category?');" title="Delete category">
                                    <i class="fas fa-trash"></i>
                                </a>
                            </div>
                        </div>
                        {% empty %}
                        <div class="list-group-item text-center py-4">
                            <p class="mb-0">No categories found</p>
                            <a href="{% url 'admin_panel:category_add' %}" class="btn btn-sm btn-primary mt-2">
                                <i class="fas fa-plus"></i> Add Category
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-8 mb-4">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="mb-0">Menu Items</h5>
                        <div>
                            <div class="btn-group btn-group-sm me-2">
                                <button type="button" class="btn btn-outline-secondary" id="exportMenuItems" title="Export menu items to CSV">
                                    <i class="fas fa-download"></i> Export
                                </button>
                                <button type="button" class="btn btn-outline-secondary" id="importMenuItems" title="Import menu items from CSV">
                                    <i class="fas fa-upload"></i> Import
                                </button>
                            </div>
                            <a href="{% url 'admin_panel:menu_item_list' %}" class="btn btn-sm btn-outline-primary">View All</a>
                        </div>
                    </div>
                    <div class="d-flex flex-wrap gap-2">
                        <div class="d-flex">
                            <input type="text" id="searchInput" class="form-control form-control-sm me-2" placeholder="Search items..." style="max-width: 200px;">
                        </div>
                        <div class="d-flex">
                            <select id="categoryFilter" class="form-select form-select-sm me-2" style="max-width: 200px;">
                                <option value="">All Categories</option>
                                {% for category in categories %}
                                <option value="{{ category.name }}">{{ category.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="d-flex">
                            <select id="sortFilter" class="form-select form-select-sm me-2" style="max-width: 200px;">
                                <option value="">Sort By</option>
                                <option value="name-asc">Name (A-Z)</option>
                                <option value="name-desc">Name (Z-A)</option>
                                <option value="price-asc">Price (Low to High)</option>
                                <option value="price-desc">Price (High to Low)</option>
                                <option value="category">Category</option>
                            </select>
                        </div>
                        <button id="resetFilter" class="btn btn-sm btn-outline-secondary">Reset All</button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <div class="bulk-actions p-2 bg-light border-bottom" style="display: none;">
                            <div class="d-flex align-items-center">
                                <span class="me-2"><span id="selectedCount">0</span> items selected</span>
                                <div class="btn-group btn-group-sm">
                                    <button type="button" class="btn btn-outline-success" id="bulkActivate">Activate</button>
                                    <button type="button" class="btn btn-outline-secondary" id="bulkDeactivate">Deactivate</button>
                                    <button type="button" class="btn btn-outline-primary" id="bulkPopular">Mark Popular</button>
                                    <button type="button" class="btn btn-outline-info" id="bulkFeatured">Mark Featured</button>
                                    <button type="button" class="btn btn-outline-warning" id="bulkPrice">Update Prices</button>
                                    <button type="button" class="btn btn-outline-danger" id="bulkDelete">Delete</button>
                                </div>
                            </div>
                        </div>
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="selectAll">
                                        </div>
                                    </th>
                                    <th>Image</th>
                                    <th>Name</th>
                                    <th>Category</th>
                                    <th>Price</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in menu_items %}
                                <tr data-item-id="{{ item.id }}">
                                    <td>
                                        <div class="form-check">
                                            <input class="form-check-input item-checkbox" type="checkbox" value="{{ item.id }}">
                                        </div>
                                    </td>
                                    <td>
                                        {% if item.image %}
                                        <img src="{{ item.image.url }}" alt="{{ item.name }}" width="50" height="50" class="rounded">
                                        {% else %}
                                        <div class="bg-secondary rounded d-flex align-items-center justify-content-center text-white" style="width: 50px; height: 50px;">
                                            <i class="fas fa-utensils"></i>
                                        </div>
                                        {% endif %}
                                    </td>
                                    <td>{{ item.name }}</td>
                                    <td>{{ item.category.name }}</td>
                                    <td>${{ item.price }}</td>
                                    <td>
                                        {% if item.is_active %}
                                        <span class="badge bg-success">Active</span>
                                        {% else %}
                                        <span class="badge bg-secondary">Inactive</span>
                                        {% endif %}

                                        {% if item.is_popular %}
                                        <span class="badge bg-primary">Popular</span>
                                        {% endif %}

                                        {% if item.is_featured %}
                                        <span class="badge bg-info">Featured</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{% url 'admin_panel:menu_item_edit' item.id %}" class="btn btn-sm btn-outline-primary me-1" title="Edit item">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="#" class="btn btn-sm btn-outline-success me-1 duplicate-item" data-item-id="{{ item.id }}" title="Duplicate item">
                                            <i class="fas fa-copy"></i>
                                        </a>
                                        <a href="{% url 'admin_panel:menu_item_delete' item.id %}" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure you want to delete this menu item?');" title="Delete item">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center py-4">
                                        <p class="mb-2">No menu items found</p>
                                        <a href="{% url 'admin_panel:menu_item_add' %}" class="btn btn-sm btn-primary">
                                            <i class="fas fa-plus"></i> Add Menu Item
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Import Modal -->
<div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importModalLabel">Import Menu Items</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Upload a CSV file with menu items. The file should have the following columns:</p>
                <ul class="small">
                    <li><strong>name</strong> - Item name (required)</li>
                    <li><strong>category</strong> - Category name (required)</li>
                    <li><strong>price</strong> - Price (required)</li>
                    <li><strong>description</strong> - Description (required)</li>
                    <li><strong>is_vegetarian</strong> - 1 for yes, 0 for no</li>
                    <li><strong>is_vegan</strong> - 1 for yes, 0 for no</li>
                    <li><strong>is_gluten_free</strong> - 1 for yes, 0 for no</li>
                    <li><strong>spice_level</strong> - 0 to 4</li>
                    <li><strong>calories</strong> - Number</li>
                    <li><strong>ingredients</strong> - Text</li>
                    <li><strong>allergens</strong> - Text</li>
                    <li><strong>is_popular</strong> - 1 for yes, 0 for no</li>
                    <li><strong>is_featured</strong> - 1 for yes, 0 for no</li>
                    <li><strong>is_seasonal</strong> - 1 for yes, 0 for no</li>
                    <li><strong>is_active</strong> - 1 for yes, 0 for no</li>
                </ul>
                <div class="mb-3">
                    <label for="csvFile" class="form-label">CSV File</label>
                    <input class="form-control" type="file" id="csvFile" accept=".csv">
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="headerRow" checked>
                    <label class="form-check-label" for="headerRow">
                        File has header row
                    </label>
                </div>
                <div class="alert alert-info">
                    <a href="#" id="downloadTemplate" class="alert-link">Download a template CSV file</a> to see the expected format.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="processImport">Import</button>
            </div>
        </div>
    </div>
</div>

<!-- Batch Price Update Modal -->
<div class="modal fade" id="batchPriceModal" tabindex="-1" aria-labelledby="batchPriceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="batchPriceModalLabel">Batch Price Update</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Update prices for selected menu items.</p>
                <div class="mb-3">
                    <label for="updateType" class="form-label">Update Type</label>
                    <select class="form-select" id="updateType">
                        <option value="percentage">Percentage Change</option>
                        <option value="fixed">Fixed Amount Change</option>
                        <option value="set">Set to Fixed Price</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="updateValue" class="form-label">Value</label>
                    <div class="input-group">
                        <span class="input-group-text" id="valuePrefix">%</span>
                        <input type="number" class="form-control" id="updateValue" step="0.01">
                    </div>
                    <div class="form-text" id="updateHelp">Enter a positive value to increase prices, negative to decrease.</div>
                </div>
                <div class="alert alert-warning">
                    This will update prices for <span id="selectedItemCount">0</span> selected items.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="applyPriceUpdate">Update Prices</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('searchInput');
        const categoryFilter = document.getElementById('categoryFilter');
        const sortFilter = document.getElementById('sortFilter');
        const resetFilterBtn = document.getElementById('resetFilter');
        const menuItemRows = document.querySelectorAll('table tbody tr');
        const selectAllCheckbox = document.getElementById('selectAll');
        const itemCheckboxes = document.querySelectorAll('.item-checkbox');
        const bulkActionsDiv = document.querySelector('.bulk-actions');
        const selectedCountSpan = document.getElementById('selectedCount');

        // Bulk action buttons
        const bulkActivateBtn = document.getElementById('bulkActivate');
        const bulkDeactivateBtn = document.getElementById('bulkDeactivate');
        const bulkPopularBtn = document.getElementById('bulkPopular');
        const bulkFeaturedBtn = document.getElementById('bulkFeatured');
        const bulkPriceBtn = document.getElementById('bulkPrice');
        const bulkDeleteBtn = document.getElementById('bulkDelete');

        // Import/Export buttons
        const exportBtn = document.getElementById('exportMenuItems');
        const importBtn = document.getElementById('importMenuItems');
        const downloadTemplateBtn = document.getElementById('downloadTemplate');
        const processImportBtn = document.getElementById('processImport');

        // Batch price update elements
        const updateTypeSelect = document.getElementById('updateType');
        const valuePrefix = document.getElementById('valuePrefix');
        const updateHelp = document.getElementById('updateHelp');
        const selectedItemCountSpan = document.getElementById('selectedItemCount');
        const applyPriceUpdateBtn = document.getElementById('applyPriceUpdate');

        // Duplicate buttons
        const duplicateButtons = document.querySelectorAll('.duplicate-item');

        // Apply all filters and sorting
        function applyFilters() {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedCategory = categoryFilter.value;
            const sortOption = sortFilter.value;

            // First hide/show rows based on search and category
            menuItemRows.forEach(row => {
                const nameCell = row.querySelector('td:nth-child(3)');
                const categoryCell = row.querySelector('td:nth-child(4)');

                if (!nameCell || !categoryCell) return; // Skip if not a regular row (like empty state)

                const name = nameCell.textContent.toLowerCase();
                const category = categoryCell.textContent;

                // Check if row matches search term and category
                const matchesSearch = searchTerm === '' || name.includes(searchTerm);
                const matchesCategory = selectedCategory === '' || category === selectedCategory;

                if (matchesSearch && matchesCategory) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });

            // Then sort visible rows
            if (sortOption !== '') {
                const tbody = document.querySelector('tbody');
                const rows = Array.from(menuItemRows).filter(row => row.style.display !== 'none');

                rows.sort((a, b) => {
                    const aNameCell = a.querySelector('td:nth-child(3)');
                    const bNameCell = b.querySelector('td:nth-child(3)');
                    const aCategoryCell = a.querySelector('td:nth-child(4)');
                    const bCategoryCell = b.querySelector('td:nth-child(4)');
                    const aPriceCell = a.querySelector('td:nth-child(5)');
                    const bPriceCell = b.querySelector('td:nth-child(5)');

                    if (!aNameCell || !bNameCell || !aCategoryCell || !bCategoryCell || !aPriceCell || !bPriceCell) {
                        return 0;
                    }

                    const aName = aNameCell.textContent;
                    const bName = bNameCell.textContent;
                    const aCategory = aCategoryCell.textContent;
                    const bCategory = bCategoryCell.textContent;
                    const aPrice = parseFloat(aPriceCell.textContent.replace('$', ''));
                    const bPrice = parseFloat(bPriceCell.textContent.replace('$', ''));

                    switch (sortOption) {
                        case 'name-asc':
                            return aName.localeCompare(bName);
                        case 'name-desc':
                            return bName.localeCompare(aName);
                        case 'price-asc':
                            return aPrice - bPrice;
                        case 'price-desc':
                            return bPrice - aPrice;
                        case 'category':
                            return aCategory.localeCompare(bCategory);
                        default:
                            return 0;
                    }
                });

                // Reorder rows in the DOM
                rows.forEach(row => tbody.appendChild(row));
            }
        }

        // Filter menu items by search term
        searchInput.addEventListener('input', applyFilters);

        // Filter menu items by category
        categoryFilter.addEventListener('change', applyFilters);

        // Sort menu items
        sortFilter.addEventListener('change', applyFilters);

        // Reset all filters
        resetFilterBtn.addEventListener('click', function() {
            searchInput.value = '';
            categoryFilter.value = '';
            sortFilter.value = '';
            menuItemRows.forEach(row => {
                row.style.display = '';
            });
        });

        // Select all checkbox
        selectAllCheckbox.addEventListener('change', function() {
            const isChecked = this.checked;

            itemCheckboxes.forEach(checkbox => {
                // Only check visible rows
                const row = checkbox.closest('tr');
                if (row.style.display !== 'none') {
                    checkbox.checked = isChecked;
                }
            });

            updateBulkActionsVisibility();
        });

        // Individual checkboxes
        itemCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                updateBulkActionsVisibility();

                // Update select all checkbox
                const allVisible = Array.from(itemCheckboxes)
                    .filter(cb => cb.closest('tr').style.display !== 'none');
                const allChecked = allVisible.every(cb => cb.checked);
                selectAllCheckbox.checked = allChecked;
            });
        });

        // Update bulk actions visibility
        function updateBulkActionsVisibility() {
            const checkedCount = document.querySelectorAll('.item-checkbox:checked').length;
            selectedCountSpan.textContent = checkedCount;

            if (checkedCount > 0) {
                bulkActionsDiv.style.display = 'block';
            } else {
                bulkActionsDiv.style.display = 'none';
            }
        }

        // Get selected item IDs
        function getSelectedItemIds() {
            return Array.from(document.querySelectorAll('.item-checkbox:checked'))
                .map(checkbox => checkbox.value);
        }

        // Bulk activate
        bulkActivateBtn.addEventListener('click', function() {
            const itemIds = getSelectedItemIds();
            if (confirm(`Are you sure you want to activate ${itemIds.length} items?`)) {
                // Here you would normally send an AJAX request to the server
                // For now, we'll just show an alert
                alert(`Items activated: ${itemIds.join(', ')}`);

                // In a real implementation, you would update the UI after successful response
                // For demonstration, let's update the UI directly
                itemIds.forEach(id => {
                    const row = document.querySelector(`tr[data-item-id="${id}"]`);
                    const statusCell = row.querySelector('td:nth-child(6)');
                    const inactiveSpan = statusCell.querySelector('.badge.bg-secondary');

                    if (inactiveSpan && inactiveSpan.textContent.trim() === 'Inactive') {
                        inactiveSpan.classList.remove('bg-secondary');
                        inactiveSpan.classList.add('bg-success');
                        inactiveSpan.textContent = 'Active';
                    }
                });
            }
        });

        // Bulk deactivate
        bulkDeactivateBtn.addEventListener('click', function() {
            const itemIds = getSelectedItemIds();
            if (confirm(`Are you sure you want to deactivate ${itemIds.length} items?`)) {
                alert(`Items deactivated: ${itemIds.join(', ')}`);

                itemIds.forEach(id => {
                    const row = document.querySelector(`tr[data-item-id="${id}"]`);
                    const statusCell = row.querySelector('td:nth-child(6)');
                    const activeSpan = statusCell.querySelector('.badge.bg-success');

                    if (activeSpan && activeSpan.textContent.trim() === 'Active') {
                        activeSpan.classList.remove('bg-success');
                        activeSpan.classList.add('bg-secondary');
                        activeSpan.textContent = 'Inactive';
                    }
                });
            }
        });

        // Bulk mark as popular
        bulkPopularBtn.addEventListener('click', function() {
            const itemIds = getSelectedItemIds();
            if (confirm(`Are you sure you want to mark ${itemIds.length} items as popular?`)) {
                alert(`Items marked as popular: ${itemIds.join(', ')}`);

                itemIds.forEach(id => {
                    const row = document.querySelector(`tr[data-item-id="${id}"]`);
                    const statusCell = row.querySelector('td:nth-child(6)');

                    // Check if Popular badge already exists
                    if (!statusCell.innerHTML.includes('Popular')) {
                        const popularBadge = document.createElement('span');
                        popularBadge.className = 'badge bg-primary ms-1';
                        popularBadge.textContent = 'Popular';
                        statusCell.appendChild(popularBadge);
                    }
                });
            }
        });

        // Bulk mark as featured
        bulkFeaturedBtn.addEventListener('click', function() {
            const itemIds = getSelectedItemIds();
            if (confirm(`Are you sure you want to mark ${itemIds.length} items as featured?`)) {
                alert(`Items marked as featured: ${itemIds.join(', ')}`);

                itemIds.forEach(id => {
                    const row = document.querySelector(`tr[data-item-id="${id}"]`);
                    const statusCell = row.querySelector('td:nth-child(6)');

                    // Check if Featured badge already exists
                    if (!statusCell.innerHTML.includes('Featured')) {
                        const featuredBadge = document.createElement('span');
                        featuredBadge.className = 'badge bg-info ms-1';
                        featuredBadge.textContent = 'Featured';
                        statusCell.appendChild(featuredBadge);
                    }
                });
            }
        });

        // Bulk delete
        bulkDeleteBtn.addEventListener('click', function() {
            const itemIds = getSelectedItemIds();
            if (confirm(`Are you sure you want to delete ${itemIds.length} items? This action cannot be undone.`)) {
                alert(`Items deleted: ${itemIds.join(', ')}`);

                // In a real implementation, you would send an AJAX request and remove rows after success
                // For demonstration, let's remove the rows directly
                itemIds.forEach(id => {
                    const row = document.querySelector(`tr[data-item-id="${id}"]`);
                    row.remove();
                });

                // Update bulk actions visibility
                updateBulkActionsVisibility();

                // If no items left, show empty state
                const remainingRows = document.querySelectorAll('tbody tr').length;
                if (remainingRows === 0) {
                    const tbody = document.querySelector('tbody');
                    const emptyRow = document.createElement('tr');
                    emptyRow.innerHTML = `
                        <td colspan="7" class="text-center py-4">
                            <p class="mb-2">No menu items found</p>
                            <a href="{% url 'admin_panel:menu_item_add' %}" class="btn btn-sm btn-primary">
                                <i class="fas fa-plus"></i> Add Menu Item
                            </a>
                        </td>
                    `;
                    tbody.appendChild(emptyRow);
                }
            }
        });

        // Handle duplicate buttons
        duplicateButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const itemId = this.getAttribute('data-item-id');
                if (confirm('Do you want to duplicate this menu item?')) {
                    window.location.href = `{% url 'admin_panel:menu_item_duplicate' 0 %}`.replace('0', itemId);
                }
            });
        });

        // Export menu items to CSV
        exportBtn.addEventListener('click', function() {
            // Get all visible menu items
            const visibleRows = Array.from(menuItemRows).filter(row => row.style.display !== 'none');

            if (visibleRows.length === 0) {
                alert('No menu items to export.');
                return;
            }

            // Create CSV content
            let csvContent = 'name,category,price,description,is_vegetarian,is_vegan,is_gluten_free,spice_level,calories,ingredients,allergens,is_popular,is_featured,is_seasonal,is_active\n';

            visibleRows.forEach(row => {
                const nameCell = row.querySelector('td:nth-child(3)');
                const categoryCell = row.querySelector('td:nth-child(4)');
                const priceCell = row.querySelector('td:nth-child(5)');
                const statusCell = row.querySelector('td:nth-child(6)');

                if (!nameCell || !categoryCell || !priceCell || !statusCell) return;

                const name = nameCell.textContent.replace(/,/g, ' ');
                const category = categoryCell.textContent.replace(/,/g, ' ');
                const price = priceCell.textContent.replace('{{ currency_symbol|default:"$" }}', '');
                const isActive = statusCell.textContent.includes('Active') ? '1' : '0';
                const isPopular = statusCell.textContent.includes('Popular') ? '1' : '0';
                const isFeatured = statusCell.textContent.includes('Featured') ? '1' : '0';

                // For demo purposes, we'll use placeholder values for other fields
                csvContent += `${name},${category},${price},"Description for ${name}",0,0,0,0,,"Ingredients for ${name}","",${isPopular},${isFeatured},0,${isActive}\n`;
            });

            // Create and download the CSV file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'menu_items.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // Show import modal
        importBtn.addEventListener('click', function() {
            const importModal = new bootstrap.Modal(document.getElementById('importModal'));
            importModal.show();
        });

        // Download template CSV
        downloadTemplateBtn.addEventListener('click', function(e) {
            e.preventDefault();

            // Create template CSV content
            const templateContent = 'name,category,price,description,is_vegetarian,is_vegan,is_gluten_free,spice_level,calories,ingredients,allergens,is_popular,is_featured,is_seasonal,is_active\n' +
                'Sample Item 1,Appetizers,9.99,"Delicious appetizer description",1,0,0,1,250,"Ingredient 1, Ingredient 2","Allergen 1, Allergen 2",1,0,0,1\n' +
                'Sample Item 2,Main Course,19.99,"Tasty main course description",0,0,1,2,450,"Ingredient 3, Ingredient 4","Allergen 3",0,1,0,1\n';

            // Create and download the template file
            const blob = new Blob([templateContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'menu_items_template.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // Process import
        processImportBtn.addEventListener('click', function() {
            const fileInput = document.getElementById('csvFile');
            const hasHeader = document.getElementById('headerRow').checked;

            if (!fileInput.files || fileInput.files.length === 0) {
                alert('Please select a CSV file to import.');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = function(e) {
                const contents = e.target.result;
                const lines = contents.split('\n');

                // Skip header row if needed
                const startIndex = hasHeader ? 1 : 0;

                // Count valid rows
                let validRows = 0;

                for (let i = startIndex; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line === '') continue;

                    const columns = line.split(',');

                    // Basic validation - need at least name, category, price, description
                    if (columns.length >= 4 && columns[0] && columns[1] && columns[2] && columns[3]) {
                        validRows++;
                    }
                }

                if (validRows === 0) {
                    alert('No valid menu items found in the CSV file.');
                    return;
                }

                if (confirm(`Found ${validRows} valid menu items to import. Proceed?`)) {
                    // In a real implementation, you would send the file to the server for processing
                    // For this demo, we'll just show a success message
                    alert(`Successfully imported ${validRows} menu items.`);

                    // Close the modal
                    const importModal = bootstrap.Modal.getInstance(document.getElementById('importModal'));
                    importModal.hide();

                    // Reset the file input
                    fileInput.value = '';
                }
            };

            reader.readAsText(file);
        });

        // Show batch price update modal
        bulkPriceBtn.addEventListener('click', function() {
            const selectedItems = getSelectedItemIds();

            if (selectedItems.length === 0) {
                alert('Please select at least one menu item.');
                return;
            }

            // Update the count in the modal
            selectedItemCountSpan.textContent = selectedItems.length;

            // Show the modal
            const batchPriceModal = new bootstrap.Modal(document.getElementById('batchPriceModal'));
            batchPriceModal.show();
        });

        // Update the prefix and help text based on the selected update type
        updateTypeSelect.addEventListener('change', function() {
            const selectedType = this.value;

            switch (selectedType) {
                case 'percentage':
                    valuePrefix.textContent = '%';
                    updateHelp.textContent = 'Enter a positive value to increase prices, negative to decrease.';
                    break;
                case 'fixed':
                    valuePrefix.textContent = '{{ currency_symbol|default:"$" }}';
                    updateHelp.textContent = 'Enter a positive value to increase prices, negative to decrease.';
                    break;
                case 'set':
                    valuePrefix.textContent = '{{ currency_symbol|default:"$" }}';
                    updateHelp.textContent = 'Enter the new price for all selected items.';
                    break;
            }
        });

        // Apply price update
        applyPriceUpdateBtn.addEventListener('click', function() {
            const selectedItems = getSelectedItemIds();
            const updateType = updateTypeSelect.value;
            const updateValue = parseFloat(document.getElementById('updateValue').value);

            if (isNaN(updateValue)) {
                alert('Please enter a valid number.');
                return;
            }

            if (confirm(`Are you sure you want to update prices for ${selectedItems.length} items?`)) {
                // Get all selected rows
                selectedItems.forEach(id => {
                    const row = document.querySelector(`tr[data-item-id="${id}"]`);
                    const priceCell = row.querySelector('td:nth-child(5)');

                    if (!priceCell) return;

                    // Get current price
                    const currentPrice = parseFloat(priceCell.textContent.replace('{{ currency_symbol|default:"$" }}', ''));
                    let newPrice;

                    // Calculate new price based on update type
                    switch (updateType) {
                        case 'percentage':
                            newPrice = currentPrice * (1 + updateValue / 100);
                            break;
                        case 'fixed':
                            newPrice = currentPrice + updateValue;
                            break;
                        case 'set':
                            newPrice = updateValue;
                            break;
                    }

                    // Ensure price is not negative
                    newPrice = Math.max(0, newPrice);

                    // Update the price in the UI
                    priceCell.textContent = `{{ currency_symbol|default:"$" }}${newPrice.toFixed(2)}`;
                });

                // Close the modal
                const batchPriceModal = bootstrap.Modal.getInstance(document.getElementById('batchPriceModal'));
                batchPriceModal.hide();

                // Reset the form
                document.getElementById('updateValue').value = '';

                // Show success message
                alert(`Prices updated for ${selectedItems.length} items.`);
            }
        });
    });
</script>
{% endblock %}